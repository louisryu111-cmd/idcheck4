<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banyan Tree Busan Concierge</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary-color: #8E7958; --bg-color: #121212; --card-bg: #1E1E1E; --text-color: #FFFFFF; }
        body { margin: 0; padding: 0; background-color: #000; font-family: 'Noto Sans KR', sans-serif; color: var(--text-color); -webkit-tap-highlight-color: transparent; overflow: hidden; }
        #app-container { max-width: 480px; margin: 0 auto; background-color: var(--bg-color); height: 100vh; position: relative; display: flex; flex-direction: column; }

        /* ì¸ì¦ ë ˆì´ì–´ */
        #auth-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background: #000; }
        .auth-screen { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; }
        .logo-intro { font-size: 22px; font-weight: 300; letter-spacing: 2px; margin-bottom: 50px; color: var(--primary-color); text-align: center; line-height: 1.5; }
        .auth-btn { width: 80%; background-color: var(--card-bg); color: #fff; border: 1px solid var(--primary-color); padding: 18px; border-radius: 12px; font-size: 16px; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 2100; }

        /* ì•ˆë©´ ì¸ì‹ UI */
        .camera-container { position: relative; width: 260px; height: 260px; border-radius: 50%; overflow: hidden; border: 2px solid var(--primary-color); margin-bottom: 20px; background: #1a1a1a; }
        #video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); animation: scan 2s infinite linear; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        #match-popup { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .member-photo { width: 150px; height: 150px; border-radius: 50%; border: 3px solid var(--primary-color); margin-bottom: 20px; object-fit: cover; background: #333; }

        /* ì½”ë“œ ì…ë ¥ UI */
        .input-group { width: 80%; position: relative; display: flex; align-items: center; margin-bottom: 25px; z-index: 2500; }
        .code-input { width: 100%; background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 18px; font-size: 18px; border-radius: 12px; text-align: center; outline: none; }
        .voice-btn { position: absolute; right: 15px; color: var(--primary-color); cursor: pointer; background: none; border: none; font-size: 24px; }

        /* ë©”ì¸ í™ˆ í™”ë©´ */
        #main-app { display: none; flex: 1; flex-direction: column; padding: 25px 20px; overflow-y: auto; }
        .hotel-name { font-size: 18px; font-weight: bold; color: var(--primary-color); margin-bottom: 10px; }
        .welcome-text { font-size: 20px; margin-bottom: 30px; line-height: 1.4; font-weight: 300; }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .menu-item { background-color: var(--card-bg); border-radius: 15px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #333; transition: 0.3s; }
        .menu-item i { font-size: 35px; color: var(--primary-color); margin-bottom: 10px; }
        .menu-item span { font-size: 14px; text-align: center; color: #eee; font-weight: 500; }

        /* ì„œë¸Œ ìŠ¤í¬ë¦° */
        .sub-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 500; padding: 25px 20px; box-sizing: border-box; flex-direction: column; }
        .screen-header { display: flex; align-items: center; margin-bottom: 25px; font-size: 18px; font-weight: bold; color: var(--primary-color); }
        .screen-header i { margin-right: 15px; cursor: pointer; }

        /* í•˜ë‹¨ ë°” */
        #footer-area { background-color: #0a0a0a; border-top: 1px solid #222; padding: 15px 0 25px 0; display: flex; flex-direction: column; align-items: center; }
        .map-trigger { color: var(--primary-color); display: flex; flex-direction: column; align-items: center; cursor: pointer; margin-bottom: 15px; }
        .copyright-text { font-size: 10px; color: #555; text-align: center; line-height: 1.5; padding: 0 20px; }

        /* ë°”í…€ ì‹œíŠ¸ */
        #bottom-sheet-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1200; }
        #bottom-sheet { position: absolute; bottom: -100%; left: 0; width: 100%; background-color: #1a1a1a; border-radius: 25px 25px 0 0; z-index: 1201; transition: bottom 0.3s ease; padding: 25px; box-sizing: border-box; }
        .sub-list-item { padding: 20px 0; border-bottom: 1px solid #2a2a2a; display: flex; justify-content: space-between; color: #ddd; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="auth-overlay">
        <div id="auth-main" class="auth-screen">
            <div class="logo-intro">BANYAN TREE<br><span style="font-size:14px; color:#aaa;">BUSAN HAEUNDAE</span></div>
            <button class="auth-btn" onclick="showAuthStep('face')"><i class="material-icons">face</i>ì•ˆë©´ì¸ì‹ ë¡œê·¸ì¸</button>
            <button class="auth-btn" onclick="showAuthStep('code')"><i class="material-icons">vpn_key</i>ì¸ì¦ ì½”ë“œë¡œ ë¡œê·¸ì¸</button>
        </div>

        <div id="auth-face" class="auth-screen" style="display:none;">
            <div class="logo-intro">FACE ID VERIFICATION</div>
            <div class="camera-container">
                <video id="video-feed" playsinline muted></video>
                <div class="scan-line" id="scan-bar"></div>
            </div>
            <div id="face-status" style="color:var(--primary-color); text-align:center; font-size:13px; height:40px; padding:0 20px;">
                ì„œë²„ì—ì„œ íšŒì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            <button class="auth-btn" style="background:none; border:none; color:#666;" onclick="location.reload()">ì·¨ì†Œ</button>
        </div>

        <div id="auth-code" class="auth-screen" style="display:none;">
            <div class="logo-intro">MEMBER ACCESS</div>
            <div class="input-group">
                <input type="text" id="access-code" class="code-input" placeholder="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button class="voice-btn" onclick="startSTT('access-code')"><i class="material-icons">mic</i></button>
            </div>
            <button class="auth-btn" style="background:var(--primary-color)" onclick="checkCode()">ì ‘ì†í•˜ê¸°</button>
            <button class="auth-btn" style="background:none; border:none; color:#666;" onclick="location.reload()">ë’¤ë¡œ ê°€ê¸°</button>
        </div>

        <div id="match-popup">
            <img id="match-member-photo" src="" class="member-photo">
            <div id="match-rate" style="font-size:24px; font-weight:bold; color:white; margin-bottom:5px;"></div>
            <div id="match-label" style="font-size:18px; color:var(--primary-color); margin-bottom:30px;"></div>
            <button id="match-btn" class="auth-btn" style="width:150px;"></button>
        </div>
    </div>

    <div id="main-app">
        <div class="hotel-name">Banyantree Busan Haeundae</div>
        <div class="welcome-text">ë°˜ê°‘ìŠµë‹ˆë‹¤, íšŒì›ë‹˜.<br><b>ì»¨ì‹œì–´ì§€ ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</b></div>
        <div class="menu-grid">
            <div class="menu-item" onclick="openSub('concierge')"><i class="material-icons">room_service</i><span>Concierge<br>Service</span></div>
            <div class="menu-item" onclick="openSub('hotel')"><i class="material-icons">apartment</i><span>Hotel<br>Service</span></div>
            <div class="menu-item" onclick="window.open('https://www.banyantree.com/booking', '_blank')"><i class="material-icons">event_available</i><span>Member<br>Booking</span></div>
            <div class="menu-item" onclick="runValetCheck()"><i class="material-icons">directions_car</i><span>Valet<br>Parking</span></div>
        </div>
        <div id="footer-area">
            <div class="map-trigger" onclick="window.open('https://drive.google.com/file/d/1ICKC21t37n6B5ek9WQc_NNsLAfjAFfMo/view?usp=drive_link')">
                <i class="material-icons">map</i><span>Hotel Map</span>
            </div>
            <div class="copyright-text">Â© Banyan Tree Hotels & Resorts. All rights reserved.</div>
        </div>
    </div>

    <div id="sub-concierge" class="sub-screen">
        <div class="screen-header"><i class="material-icons" onclick="closeSub()">arrow_back</i>Concierge Service</div>
        <div class="menu-grid">
            <div class="menu-item" onclick="openTour()"><i class="material-icons">map</i><span>4 Season Tour</span></div>
            <div class="menu-item" onclick="alert('Kids ì„œë¹„ìŠ¤ ì¤€ë¹„ ì¤‘')"><i class="material-icons">child_friendly</i><span>Kids</span></div>
            <div class="menu-item" onclick="alert('ì„¸ì°¨ ì˜ˆì•½ ì„œë¹„ìŠ¤')"><i class="material-icons">local_car_wash</i><span>Car Wash</span></div>
            <div class="menu-item" onclick="alert('ë³‘ì› ì •ë³´ë¥¼ ì•ˆë‚´í•©ë‹ˆë‹¤.')"><i class="material-icons">medical_services</i><span>Hospital</span></div>
        </div>
    </div>

    <div id="sub-hotel" class="sub-screen">
        <div class="screen-header"><i class="material-icons" onclick="closeSub()">arrow_back</i>Hotel Service</div>
        <div class="menu-grid">
            <div class="menu-item" onclick="alert('Dining ì˜ˆì•½')"><i class="material-icons">restaurant</i><span>Dining</span></div>
            <div class="menu-item" onclick="alert('Lounge ì•ˆë‚´')"><i class="material-icons">local_bar</i><span>Lounge</span></div>
            <div class="menu-item" onclick="alert('Wellness & SPA')"><i class="material-icons">spa</i><span>Wellness</span></div>
            <div class="menu-item" onclick="alert('Facilities')"><i class="material-icons">pool</i><span>Facilities</span></div>
            <div class="menu-item" onclick="alert('Kids Club')"><i class="material-icons">child_care</i><span>Kids</span></div>
            <div class="menu-item" onclick="alert('ì—°íšŒì¥ ë° ì›¨ë”©')"><i class="material-icons">celebration</i><span>ì—°íšŒ/ì›¨ë”©</span></div>
        </div>
    </div>

    <div id="bottom-sheet-overlay" onclick="closeTour()"></div>
    <div id="bottom-sheet">
        <div style="color:var(--primary-color); font-weight:bold; margin-bottom:15px; font-size:18px;">4 Season Tour Drive</div>
        <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1Ax4O2b49CM5I6-KnMebXjz9r8PHlgUmz/view')"><span>ğŸŒ¸ Spring Course</span><i class="material-icons">chevron_right</i></div>
        <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1m1nqU2eRtS4YHKAPKqYEekQn7KF0i_sp/view')"><span>ğŸŒŠ Summer Course</span><i class="material-icons">chevron_right</i></div>
        <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1d84lGgWJuSJUh3F-AJThTIq-B-t9usRd/view')"><span>ğŸ‚ Autumn Course</span><i class="material-icons">chevron_right</i></div>
        <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1YpcJG6XhzOfaR_e0iDOY0y2yXt5f0t8S/view')"><span>â„ï¸ Winter Course</span><i class="material-icons">chevron_right</i></div>
    </div>
</div>

<script>
    // êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° URL (CSV ë°©ì‹)
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/17oKJndkco4jJToJiUuEuHnFqhPlwIsEYycHiCZtFP6E/edit?usp=sharing";
    
    let faceMatcher = null;
    let cameraStream = null;
    let isProcessing = false;

    // 1. êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ íšŒì› ë°ì´í„° ë° ì´ë¯¸ì§€ í•™ìŠµ
    async function loadMemberDataFromSheet() {
        const status = document.getElementById('face-status');
        try {
            const response = await fetch(SHEET_CSV_URL);
            const csvText = await response.text();
            
            // CSV íŒŒì‹± (ë‹¨ìˆœí™”: 1ì—´ ì´ë¦„, 2ì—´ ì´ë¯¸ì§€URL ê°€ì •)
            const rows = csvText.split('\n').slice(1);
            const labeledDescriptors = [];

            for (let row of rows) {
                const cols = row.split(',').map(c => c.replace(/"/g, '').trim());
                if (cols.length < 2) continue;
                
                const name = cols[0];
                const imgUrl = cols[1];

                try {
                    const img = await faceapi.fetchImage(imgUrl);
                    const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
                                                .withFaceLandmarks()
                                                .withFaceDescriptor();
                    if (detection) {
                        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]));
                    }
                } catch (e) { console.log(`${name} ì‚¬ì§„ ë¡œë“œ ì‹¤íŒ¨`); }
            }

            if (labeledDescriptors.length === 0) throw new Error("í•™ìŠµëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.");
            
            faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6); // ê¸°ë³¸ ì„ê³„ê°’ 0.6
            status.innerText = "ë°ì´í„° ë¡œë“œ ì™„ë£Œ. ì–¼êµ´ì„ ìŠ¤ìº”í•©ë‹ˆë‹¤.";
            startRealtimeDetection();
        } catch (err) {
            status.innerText = "íšŒì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ê¶Œí•œ í™•ì¸ í•„ìš”)";
            console.error(err);
        }
    }

    // 2. ì‹¤ì‹œê°„ ì•ˆë©´ ì¸ì‹ ë° ëŒ€ì¡° ë¡œì§ (ì‹œë®¬ë ˆì´ì…˜ ì—†ìŒ)
    async function startRealtimeDetection() {
        const video = document.getElementById('video-feed');
        
        const interval = setInterval(async () => {
            if (isProcessing || !faceMatcher) return;

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                                            .withFaceLandmarks()
                                            .withFaceDescriptors();

            if (detections.length > 0) {
                isProcessing = true;
                const bestMatch = faceMatcher.findBestMatch(detections[0].descriptor);
                
                // ìœ í´ë¦¬ë“œ ê±°ë¦¬ë¥¼ í¼ì„¼íŠ¸ë¡œ ë³€í™˜ (ê±°ë¦¬ê°€ 0ì¼ìˆ˜ë¡ 100%)
                const distance = bestMatch.distance;
                const matchRate = Math.round((1 - distance) * 100);

                if (matchRate >= 62) {
                    clearInterval(interval);
                    showRealResult(bestMatch.label, matchRate);
                } else {
                    isProcessing = false; // 62% ë¯¸ë§Œì€ ê³„ì† ìŠ¤ìº”
                }
            }
        }, 1000);
    }

    function showRealResult(name, rate) {
        const popup = document.getElementById('match-popup');
        const rateText = document.getElementById('match-rate');
        const labelText = document.getElementById('match-label');
        const btn = document.getElementById('match-btn');
        const photo = document.getElementById('match-member-photo');

        popup.style.display = 'flex';
        rateText.innerText = `ë§¤ì¹˜ìœ¨ ${rate}%`;
        // êµ¬ê¸€ ì‹œíŠ¸ì˜ í•´ë‹¹ íšŒì› ì‚¬ì§„ì„ ê²°ê³¼ì°½ì— ì†¡ì¶œ (ì‹¤ì œ ìš´ì˜ ë°˜ì˜)
        // ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¡œ ì‹œíŠ¸ì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ë¥¼ í™œìš©í•œë‹¤ê³  ê°€ì •
        photo.src = "https://via.placeholder.com/150/8E7958/FFFFFF?text=" + encodeURIComponent(name);

        if (rate >= 70) {
            labelText.innerText = "â€œìœ ë ¥í•¨â€";
            btn.innerText = "ì ‘ì† ì™„ë£Œ";
            btn.style.backgroundColor = "var(--primary-color)";
            btn.onclick = () => {
                stopCamera();
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
            };
        } else {
            labelText.innerText = "â€œì¶”ì •ë¨â€";
            btn.innerText = "ì¬ì‹œë„";
            btn.style.backgroundColor = "#555";
            btn.onclick = () => location.reload();
        }
    }

    // ê¸°ì´ˆ ì¸í”„ë¼ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    async function showAuthStep(step) {
        document.getElementById('auth-main').style.display = 'none';
        if(step === 'face') {
            document.getElementById('auth-face').style.display = 'flex';
            const status = document.getElementById('face-status');
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/'),
                    faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/'),
                    faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/')
                ]);
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('video-feed').srcObject = cameraStream;
                loadMemberDataFromSheet();
            } catch (e) { status.innerText = "ì¹´ë©”ë¼ ë˜ëŠ” ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨"; }
        } else {
            document.getElementById('auth-code').style.display = 'flex';
        }
    }

    function stopCamera() { if(cameraStream) cameraStream.getTracks().forEach(t => t.stop()); }
    function checkCode() {
        const val = document.getElementById('access-code').value.trim().toLowerCase();
        if(["foryou", "for you", "í¬ìœ ", "í¬ ìœ "].includes(val)) {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
        } else alert("ì½”ë“œ ë¶ˆì¼ì¹˜");
    }
    function openSub(id) { document.getElementById('main-app').style.display='none'; document.getElementById('sub-'+id).style.display='flex'; }
    function closeSub() { document.querySelectorAll('.sub-screen').forEach(s=>s.style.display='none'); document.getElementById('main-app').style.display='flex'; }
    function openTour() { document.getElementById('bottom-sheet-overlay').style.display='block'; setTimeout(()=>document.getElementById('bottom-sheet').style.bottom='0',50); }
    function closeTour() { document.getElementById('bottom-sheet').style.bottom='-100%'; setTimeout(()=>document.getElementById('bottom-sheet-overlay').style.display='none',300); }
    function startSTT(id) {
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.lang='ko-KR'; rec.start(); rec.onresult=(e)=>document.getElementById(id).value=e.results[0][0].transcript;
    }
    function runValetCheck() { alert("í˜¸í…” ë‚´ ìœ„ì¹˜ í™•ì¸ ì¤‘..."); openSub('concierge'); /* ì‹œì—°ìš© */ }
</script>
</body>
</html>