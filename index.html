<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banyan Tree Busan | Professional Security</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400..900;1,400..900&family=Noto+Sans+KR:wght@300;400;700&display=swap');
        :root { --banyan-gold: #c5a059; --banyan-dark: #0a0c10; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--banyan-dark); color: #ffffff; overflow-x: hidden; }
        .serif { font-family: 'Bodoni Moda', serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(197, 160, 89, 0.25); }
        .video-container { position: relative; width: 100%; border-radius: 2.5rem; overflow: hidden; box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.7); border: 1px solid rgba(197, 160, 89, 0.2); }
        #webcam, #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .btn-premium { background: linear-gradient(135deg, #c5a059 0%, #a38141 100%); color: #000; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-premium:disabled { opacity: 0.2; transform: scale(0.98); }
        .log-box::-webkit-scrollbar { width: 2px; }
        .log-box::-webkit-scrollbar-thumb { background: var(--banyan-gold); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="p-8 flex justify-between items-center">
        <div class="space-y-1">
            <p class="serif text-[10px] tracking-[0.4em] text-[#c5a059] uppercase">Banyan Tree</p>
            <h1 class="text-xl font-light tracking-widest uppercase">Busan</h1>
        </div>
        <div id="connection-status" class="flex items-center text-[10px] text-slate-500 uppercase tracking-tighter">
            <span class="status-dot w-2 h-2 rounded-full bg-red-500 animate-pulse mr-2"></span> Offline
        </div>
    </header>

    <main class="flex-1 px-6 max-w-5xl mx-auto w-full pb-10 space-y-6">
        
        <!-- Login Section -->
        <div id="login-panel" class="glass-panel max-w-lg mx-auto rounded-[3.5rem] p-12 text-center space-y-10 mt-6">
            <div class="space-y-2">
                <div class="serif text-5xl text-[#c5a059] font-light italic">Access</div>
                <div class="h-px w-12 bg-[#c5a059]/30 mx-auto"></div>
            </div>
            <p class="text-[11px] text-slate-400 font-light leading-relaxed tracking-tight">
                반얀트리 부산의 프라이빗 서비스를 위해<br>멤버십 인증이 필요합니다.
            </p>
            <button id="btn-login" class="w-full btn-premium py-5 rounded-full font-bold text-xs tracking-[0.2em] uppercase shadow-2xl">
                Google 계정 인증 시작
            </button>
        </div>

        <!-- Main Workspace -->
        <div id="app-panel" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8 animate-in fade-in duration-1000">
            
            <!-- Left Column: Camera -->
            <div class="space-y-4">
                <div class="video-container aspect-video lg:aspect-[4/3]">
                    <video id="webcam" autoplay playsinline muted></video>
                    <canvas id="overlay"></canvas>
                    
                    <div id="loading-overlay" class="absolute inset-0 bg-[#0a0c10] flex flex-col items-center justify-center text-center">
                        <div class="w-16 h-16 border-t-2 border-[#c5a059] rounded-full animate-spin mb-6"></div>
                        <p class="serif text-sm text-[#c5a059] tracking-[0.3em] uppercase">Syncing Security</p>
                        <p id="sync-detail" class="text-[9px] text-slate-600 mt-4 uppercase tracking-widest font-mono italic">Initializing Face-AI...</p>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-3">
                    <button id="btn-start" disabled class="col-span-3 btn-premium py-4 rounded-full font-bold text-[11px] tracking-[0.2em] uppercase">시스템 가동</button>
                    <button id="btn-next-camera" title="카메라 전환" class="col-span-1 bg-white/5 border border-[#c5a059]/30 rounded-full flex items-center justify-center text-[#c5a059] active:scale-90 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Right Column: Results & Logs -->
            <div class="space-y-6">
                <div id="result-box" class="hidden relative glass-panel rounded-[2.5rem] p-8 animate-in slide-in-from-bottom-4 duration-500">
                    <div class="absolute top-5 right-5 bg-black/50 border border-[#c5a059]/50 text-[#c5a059] px-3 py-1 rounded-full text-[10px] font-bold tracking-widest flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 bg-[#c5a059] rounded-full animate-ping"></div>
                        <span id="match-percent">0</span>% MATCH
                    </div>
                    
                    <div class="flex items-center gap-6 mt-2">
                        <div class="relative">
                            <img id="user-img" src="" class="w-20 h-20 rounded-full object-cover border-2 border-[#c5a059]/40 p-1 bg-black/40">
                            <div class="absolute inset-0 rounded-full border border-[#c5a059]/20 animate-pulse"></div>
                        </div>
                        <div class="space-y-1">
                            <div class="serif text-[10px] text-[#c5a059] tracking-widest uppercase">Verified Member</div>
                            <div id="user-name" class="text-2xl font-light tracking-tight text-white">---</div>
                            <div id="user-dept" class="text-slate-500 text-xs font-light">---</div>
                        </div>
                    </div>
                </div>

                <div class="bg-black/40 rounded-[2rem] p-6 border border-white/5">
                    <div class="flex justify-between items-center mb-4">
                        <span class="serif text-[9px] text-[#c5a059] tracking-[0.2em] uppercase opacity-70">Security Logs</span>
                        <span id="cam-info" class="text-[8px] font-mono text-slate-600 uppercase tracking-tighter">No Camera Detected</span>
                    </div>
                    <div id="console" class="log-box h-48 overflow-y-auto text-[9px] font-mono text-slate-500 space-y-1.5">
                        <div>> System Standby. Waiting for Auth...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const CLIENT_ID = '88725170403-lkp5homgvhjv50ffoadde8u43sfr8dba.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1X1O3wvZ2j_sUeJSifv0Uiex55kAzFEhtZ5vgTlgmIwY';
        const SHEET_NAME = 'sheet1';

        let accessToken = null;
        let tokenClient;
        let faceMatcher = null;
        let videoDevices = [];
        let currentDeviceIndex = 0;
        let currentStream = null;

        const consoleEl = document.getElementById('console');
        function printLog(msg, type = 'info') {
            const div = document.createElement('div');
            div.textContent = `> ${msg.toUpperCase()}`;
            if (type === 'error') div.className = 'text-red-500 font-bold';
            if (type === 'success') div.className = 'text-[#c5a059] font-bold';
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // 카메라 장치 목록을 갱신하는 함수
        async function updateDeviceList() {
            try {
                // 권한을 먼저 요청하여 장치 레이블을 가져옵니다.
                await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(d => d.kind === 'videoinput');
                
                printLog(`${videoDevices.length}개의 카메라 감지됨`, "success");
                videoDevices.forEach((d, i) => {
                    printLog(`[CH ${i}] ${d.label || 'Unknown Camera'}`);
                });
            } catch (err) {
                printLog("카메라 권한 거부됨: " + err.message, "error");
            }
        }

        window.onload = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/drive.readonly',
                callback: async (res) => {
                    if (res.error) return printLog("Auth Error: " + res.error, "error");
                    accessToken = res.access_token;
                    document.getElementById('login-panel').style.display = 'none';
                    document.getElementById('app-panel').classList.remove('hidden');
                    document.getElementById('connection-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Online';
                    printLog("Authentication Successful", "success");
                    await initSecuritySystem();
                }
            });
        };

        document.getElementById('btn-login').onclick = () => tokenClient.requestAccessToken();

        async function initSecuritySystem() {
            try {
                const syncMsg = document.getElementById('sync-detail');
                syncMsg.textContent = "Loading Face-AI Models...";
                
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                printLog("AI Models Ready");

                syncMsg.textContent = "Fetching Member Data...";
                const range = encodeURIComponent(`${SHEET_NAME}!A1:E500`);
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                const data = await res.json();
                const users = (data.values || []).slice(1).map(row => ({
                    id: row[0], name: row[1], dept: row[2], url: row[3]
                })).filter(u => u.url && u.name);

                printLog(`${users.length}명의 데이터 분석 중...`);

                const descriptors = await Promise.all(users.map(async user => {
                    try {
                        let img;
                        if (user.url.includes("drive.google.com")) {
                            const fId = user.url.match(/[-\w]{25,}/)[0];
                            const dRes = await fetch(`https://www.googleapis.com/drive/v3/files/${fId}?alt=media`, { headers: { Authorization: `Bearer ${accessToken}` } });
                            img = await faceapi.bufferToImage(await dRes.blob());
                        } else {
                            img = await faceapi.fetchImage(`https://wsrv.nl/?url=${encodeURIComponent(user.url)}&output=jpg`);
                        }
                        const d = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                        return d ? new faceapi.LabeledFaceDescriptors(`${user.name}|${user.dept}|${user.url}`, [d.descriptor]) : null;
                    } catch (e) { return null; }
                }));

                faceMatcher = new faceapi.FaceMatcher(descriptors.filter(d => d !== null), 0.55);
                
                await updateDeviceList();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('btn-start').disabled = false;
                printLog("Security System Armed", "success");
            } catch (err) {
                printLog("초기화 실패: " + err.message, "error");
            }
        }

        async function startScanning(index) {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(t => t.stop());
                    printLog("이전 스트림 중지됨");
                }
                
                const device = videoDevices[index];
                document.getElementById('cam-info').textContent = device ? (device.label || `CH ${index}`) : 'Searching...';
                
                // 노트북 웹캠 및 모바일 외부 카메라 호환성을 위한 제약 조건 설정
                const constraints = {
                    video: device && device.deviceId ? { deviceId: { exact: device.deviceId } } : { facingMode: 'user' }
                };

                printLog(`${device ? device.label : '기본'} 카메라 연결 시도...`);
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('webcam');
                video.srcObject = currentStream;
                
                // 모바일 크롬 브라우저 정책 대응
                await video.play();
                
                video.onloadedmetadata = () => {
                    const canvas = document.getElementById('overlay');
                    const displaySize = { width: video.videoWidth, height: video.videoHeight };
                    faceapi.matchDimensions(canvas, displaySize);
                    
                    printLog("비디오 스트림 활성화", "success");

                    const detectionLoop = setInterval(async () => {
                        if (video.paused || video.ended) return;
                        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
                        const resized = faceapi.resizeResults(detections, displaySize);
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);

                        resized.forEach(d => {
                            const match = faceMatcher.findBestMatch(d.descriptor);
                            const isUnknown = match.label.includes('unknown');
                            const confidence = Math.max(0, Math.round((1 - match.distance) * 100));
                            
                            if (!isUnknown) {
                                const [name, dept, url] = match.label.split('|');
                                document.getElementById('result-box').classList.remove('hidden');
                                document.getElementById('user-name').textContent = name;
                                document.getElementById('user-dept').textContent = dept;
                                document.getElementById('match-percent').textContent = confidence;
                                
                                const fId = url.match(/[-\w]{25,}/);
                                document.getElementById('user-img').src = fId ? `https://lh3.googleusercontent.com/u/0/d/${fId[0]}` : url;
                            }

                            const boxColor = isUnknown ? '#ff4444' : '#c5a059';
                            ctx.strokeStyle = boxColor;
                            ctx.lineWidth = 4;
                            ctx.strokeRect(d.detection.box.x, d.detection.box.y, d.detection.box.width, d.detection.box.height);
                            
                            if (!isUnknown) {
                                ctx.fillStyle = boxColor;
                                ctx.font = 'bold 16px "Noto Sans KR"';
                                ctx.fillText(`${confidence}% MATCH`, d.detection.box.x, d.detection.box.y - 10);
                            }
                        });
                    }, 500);
                };
            } catch (e) {
                printLog("연결 실패: " + e.message, "error");
                // exact 조건 실패 시 fallback 시도
                if (e.name === 'OverconstrainedError') {
                    printLog("재시도: 일반 모드로 연결 중...");
                    currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    document.getElementById('webcam').srcObject = currentStream;
                }
            }
        }

        document.getElementById('btn-start').onclick = () => startScanning(currentDeviceIndex);
        
        document.getElementById('btn-next-camera').onclick = async () => {
            if (videoDevices.length === 0) await updateDeviceList();
            if (videoDevices.length > 0) {
                currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
                startScanning(currentDeviceIndex);
            } else {
                printLog("사용 가능한 카메라가 없습니다.", "error");
            }
        };

        // 하드웨어 변경 감지
        navigator.mediaDevices.ondevicechange = () => {
            printLog("하드웨어 변경 감지됨 - 장치 목록 갱신");
            updateDeviceList();
        };
    </script>
</body>
</html>