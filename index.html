<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banyan Tree Busan Concierge</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary-color: #8E7958; --bg-color: #121212; --card-bg: #1E1E1E; --text-color: #FFFFFF; }
        body { margin: 0; padding: 0; background-color: #000; font-family: 'Noto Sans KR', sans-serif; color: var(--text-color); overflow: hidden; }
        #app-container { max-width: 480px; margin: 0 auto; background-color: var(--bg-color); height: 100vh; position: relative; display: flex; flex-direction: column; }
        
        /* ì¸ì¦ ë ˆì´ì–´ */
        #auth-overlay { position: absolute; inset: 0; z-index: 2000; background: #000; }
        .auth-screen { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; inset: 0; }
        .logo-intro { font-size: 22px; font-weight: 300; letter-spacing: 2px; margin-bottom: 50px; color: var(--primary-color); text-align: center; }
        .auth-btn { width: 80%; background-color: var(--card-bg); color: #fff; border: 1px solid var(--primary-color); padding: 18px; border-radius: 12px; font-size: 16px; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* ì•ˆë©´ ì¸ì‹ UI */
        .camera-container { position: relative; width: 280px; height: 280px; border-radius: 50%; overflow: hidden; border: 3px solid var(--primary-color); margin-bottom: 20px; background: #1a1a1a; }
        #video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); animation: scan 2s infinite linear; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        #face-status { color: var(--primary-color); text-align: center; font-size: 14px; margin-bottom: 10px; }
        #debug-log { width: 80%; height: 60px; font-size: 10px; color: #666; overflow-y: auto; text-align: left; background: #000; padding: 5px; border-radius: 5px; font-family: monospace; }

        /* ë©”ì¸ ì•± */
        #main-app { display: none; flex: 1; flex-direction: column; padding: 25px 20px; overflow-y: auto; }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .menu-item { background-color: var(--card-bg); border-radius: 15px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #333; cursor: pointer; text-align: center; padding: 5px; }
        .menu-item i { font-size: 35px; color: var(--primary-color); margin-bottom: 10px; }
        
        /* í‘¸í„°(Copyright) */
        .footer { margin-top: auto; padding: 20px 0; text-align: center; font-size: 11px; color: #555; letter-spacing: 1px; }

        /* ì„œë¸Œ í™”ë©´ */
        .sub-screen { display: none; position: absolute; inset: 0; background-color: var(--bg-color); z-index: 500; padding: 25px 20px; flex-direction: column; overflow-y: auto; }
        .back-btn { color: var(--primary-color); display: flex; align-items: center; cursor: pointer; margin-bottom: 20px; }

        /* ìŒì„±ì¸ì‹ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .input-group { position: relative; width: 80%; margin-bottom: 20px; }
        #access-code { width: 100%; padding: 15px; padding-right: 50px; background:#1a1a1a; color:#fff; border:1px solid #444; border-radius:10px; text-align:center; box-sizing: border-box; font-size: 16px; }
        #voice-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--primary-color); cursor: pointer; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="auth-overlay">
        <div id="auth-main" class="auth-screen">
            <div class="logo-intro">BANYAN TREE<br><span style="font-size:14px; color:#aaa;">BUSAN HAEUNDAE</span></div>
            <button class="auth-btn" onclick="showAuthStep('face')"><i class="material-icons">face</i>ì•ˆë©´ì¸ì‹ ë¡œê·¸ì¸</button>
            <button class="auth-btn" onclick="showAuthStep('code')"><i class="material-icons">vpn_key</i>ì¸ì¦ ì½”ë“œë¡œ ë¡œê·¸ì¸</button>
        </div>

        <div id="auth-face" class="auth-screen" style="display:none;">
            <div class="logo-intro" style="margin-bottom:20px; font-size:18px;">FACE ID VERIFICATION</div>
            <div class="camera-container">
                <video id="video-feed" autoplay muted playsinline></video>
                <div class="scan-line"></div>
            </div>
            <div id="face-status">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
            <div id="debug-log"></div>
            <button class="auth-btn" style="background:none; border:none; color:#666; margin-top:10px;" onclick="location.reload()">ë’¤ë¡œê°€ê¸°</button>
        </div>

        <div id="auth-code" class="auth-screen" style="display:none;">
            <div class="logo-intro" style="font-size:18px;">ENTER ACCESS CODE</div>
            <div class="input-group">
                <input type="text" id="access-code" placeholder="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <i class="material-icons" id="voice-btn" onclick="startVoiceRecognition()">mic</i>
            </div>
            <button class="auth-btn" style="background:var(--primary-color)" onclick="checkCode()">ì ‘ì†</button>
            <button class="auth-btn" style="background:none; border:none; color:#666;" onclick="location.reload()">ë’¤ë¡œê°€ê¸°</button>
        </div>
    </div>

    <div id="main-app">
        <div style="color:var(--primary-color); font-weight:bold; margin-bottom:5px;">Banyan Tree Busan</div>
        <div style="font-size:22px; margin-bottom:30px; font-weight:300;">ë°˜ê°‘ìŠµë‹ˆë‹¤, <b id="user-name">íšŒì›</b>ë‹˜.</div>
        
        <div class="menu-grid">
            <div class="menu-item" onclick="openSub('concierge')"><i class="material-icons">room_service</i><span>Concierge Service</span></div>
            <div class="menu-item" onclick="openSub('hotel')"><i class="material-icons">apartment</i><span>Hotel Service</span></div>
            <div class="menu-item" onclick="window.open('https://www.banyantree.com', '_blank')"><i class="material-icons">event_available</i><span>Booking</span></div>
            <div class="menu-item" onclick="openSub('valet')"><i class="material-icons">directions_car</i><span>Valet</span></div>
        </div>

        <div class="footer">
            COPYRIGHT Â© BANYAN TREE BUSAN HAEUNDAE. ALL RIGHTS RESERVED.
        </div>
    </div>

    <div id="sub-concierge" class="sub-screen">
        <div class="back-btn" onclick="closeSub()"><i class="material-icons">arrow_back</i> ë’¤ë¡œê°€ê¸°</div>
        <h2 style="margin-bottom:25px;">Concierge Service</h2>
        <div class="menu-grid">
            <div class="menu-item" onclick="openTour()"><i class="material-icons">map</i><span>4 Season Tour</span></div>
            <div class="menu-item" onclick="alert('Kids ì„œë¹„ìŠ¤ ì¤€ë¹„ ì¤‘')"><i class="material-icons">child_friendly</i><span>Kids</span></div>
            <div class="menu-item" onclick="alert('ì„¸ì°¨ ì˜ˆì•½ ì„œë¹„ìŠ¤')"><i class="material-icons">local_car_wash</i><span>Car Wash</span></div>
            <div class="menu-item" onclick="alert('ë³‘ì› ì •ë³´ë¥¼ ì•ˆë‚´í•©ë‹ˆë‹¤.')"><i class="material-icons">medical_services</i><span>Hospital</span></div>
        </div>
    </div>

    <div id="sub-hotel" class="sub-screen">
        <div class="back-btn" onclick="closeSub()"><i class="material-icons">arrow_back</i> ë’¤ë¡œê°€ê¸°</div>
        <h2 style="margin-bottom:25px;">Hotel Service</h2>
    <div class="menu-grid">
            <div class="menu-item" onclick="alert('Dining ì˜ˆì•½')"><i class="material-icons">restaurant</i><span>Dining</span></div>
            <div class="menu-item" onclick="alert('Lounge ì•ˆë‚´')"><i class="material-icons">local_bar</i><span>Lounge</span></div>
            <div class="menu-item" onclick="alert('Wellness & SPA')"><i class="material-icons">spa</i><span>Wellness</span></div>
            <div class="menu-item" onclick="alert('Facilities')"><i class="material-icons">pool</i><span>Facilities</span></div>
            <div class="menu-item" onclick="alert('Kids Club')"><i class="material-icons">child_care</i><span>Kids</span></div>
            <div class="menu-item" onclick="alert('Event & Wedding')"><i class="material-icons">celebration</i><span>Event & Wedding</span></div>
        </div>
    </div>

    <div id="bottom-sheet-overlay" onclick="closeTour()"></div>
    <div id="bottom-sheet">
        <div style="color:var(--primary-color); font-weight:bold; margin-bottom:15px; font-size:18px;">4 Season Tour Drive</div>
        <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1Ax4O2b49CM5I6-KnMebXjz9r8PHlgUmz/view')"><span>ğŸŒ¸ Spring Course</span><i class="material-icons">chevron_right</i></div>
        <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1m1nqU2eRtS4YHKAPKqYEekQn7KF0i_sp/view')"><span>ğŸŒŠ Summer Course</span><i class="material-icons">chevron_right</i></div>
        <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1d84lGgWJuSJUh3F-AJThTIq-B-t9usRd/view')"><span>ğŸ‚ Autumn Course</span><i class="material-icons">chevron_right</i></div>
        <div class="sub-list-item" onclick="window.open('https://drive.google.com/file/d/1YpcJG6XhzOfaR_e0iDOY0y2yXt5f0t8S/view')"><span>â„ï¸ Winter Course</span><i class="material-icons">chevron_right</i></div>
    </div>
</div>

    <div id="sub-valet" class="sub-screen">
        <div class="back-btn" onclick="closeSub()"><i class="material-icons">arrow_back</i> ë’¤ë¡œê°€ê¸°</div>
        <h2 style="margin-bottom:25px;">Valet Service</h2>
       <div style="text-align:center; padding:20px; color:#aaa; font-size:14px; line-height:1.6;">í˜¸í…” ë‚´ ì²´ë¥˜ ì¤‘ì¸ ê³ ê°ë‹˜ì„ ìœ„í•œ ì „ìš© ì¶œì°¨ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</div>
        <div class="input-group" style="width:100%;">
            <input type="text" id="car-num" class="code-input" placeholder="ì°¨ëŸ‰ë²ˆí˜¸ ì „ì²´ ì…ë ¥">
            <button class="voice-btn" onclick="startSTT('car-num')"><i class="material-icons">mic</i></button>
        </div>
        <button class="auth-btn" style="width:100%; background:var(--primary-color);" onclick="sendValet()">ì¶œì°¨ ìš”ì²­í•˜ê¸°</button>
    </div>

<script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRjdw6b40uOKNdnSDIL0Hmz_5wiRsJV6WznPvR_fNAmneePy-JcE6DIlC5E_Asdhb-jGeh_01VzR8H-/pub?output=csv";
    let faceMatcher = null;
    let isDetected = false;

    function log(m) {
        const d = document.getElementById('debug-log');
        d.innerHTML += `> ${m}<br>`;
        d.scrollTop = d.scrollHeight;
    }

    function alertLink() { alert("í™ˆí˜ì´ì§€ êµ¬ì¶• í›„ ë§í¬ ì—°ê²° ì˜ˆì •ì…ë‹ˆë‹¤."); }

    function fixUrl(url) {
        if (!url) return "";
        let id = "";
        const clean = url.replace(/"/g, '').trim();
        if (clean.includes('id=')) id = clean.split('id=')[1].split('&')[0];
        else if (clean.includes('/d/')) id = clean.split('/d/')[1].split('/')[0];
        if (id) return `https://images.weserv.nl/?url=${encodeURIComponent(`https://docs.google.com/uc?export=view&id=${id}`)}`;
        return clean;
    }

    async function showAuthStep(step) {
        document.getElementById('auth-main').style.display = 'none';
        if (step === 'face') {
            document.getElementById('auth-face').style.display = 'flex';
            initFaceAuth();
        } else {
            document.getElementById('auth-code').style.display = 'flex';
        }
    }

    async function initFaceAuth() {
        try {
            log("ëª¨ë¸ ë¡œë”© ì¤‘...");
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            log("ì¹´ë©”ë¼ í™œì„±í™”...");
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            const video = document.getElementById('video-feed');
            video.srcObject = stream;
            video.onloadedmetadata = () => video.play();
            loadData();
        } catch (e) { log("ì¹´ë©”ë¼ ì—ëŸ¬: " + e.message); }
    }

    async function loadData() {
        try {
            log("ë°ì´í„° ì—°ë™ ì¤‘...");
            const res = await fetch(SHEET_URL + "&t=" + Date.now());
            const text = await res.text();
            const rows = text.split('\n').slice(1);
            const labeled = [];

            for (let row of rows) {
                const col = row.split(',');
                if (col.length < 2) continue;
                const name = col[0].trim();
                const url = fixUrl(col[1].trim());
                if (!name || !url) continue;

                // ìš”ì²­ ë°˜ì˜: ì‹¤ëª… ëŒ€ì‹  ë¬¸êµ¬ í‘œì‹œ
                log(`íšŒì› ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...`);
                try {
                    const img = await faceapi.fetchImage(url);
                    const det = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    if (det) labeled.push(new faceapi.LabeledFaceDescriptors(name, [det.descriptor]));
                } catch (e) {}
            }
            if (labeled.length === 0) throw new Error("ë°ì´í„° ì—†ìŒ");
            faceMatcher = new faceapi.FaceMatcher(labeled, 0.45);
            document.getElementById('face-status').innerText = "ì¸ì‹ ì¤€ë¹„ ì™„ë£Œ!";
            startRecognition();
        } catch (e) { log("ì—°ë™ ì‹¤íŒ¨: " + e.message); }
    }

    async function startRecognition() {
        const video = document.getElementById('video-feed');
        const scan = async () => {
            if (isDetected || !faceMatcher) return;
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
            if (detections.length > 0) {
                const match = faceMatcher.findBestMatch(detections[0].descriptor);
                const score = Math.round((1 - match.distance) * 100);
                if (score >= 70 && match.label !== "unknown") {
                    isDetected = true;
                    // ìš”ì²­ ë°˜ì˜: 76% ì´ìƒì¼ ë•Œë§Œ ì´ë¦„ í‘œì‹œ
                    const displayName = (score >= 76) ? match.label : "íšŒì›";
                    loginSuccess(displayName);
                    return;
                }
            }
            requestAnimationFrame(scan);
        };
        scan();
    }

    function loginSuccess(name) {
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('user-name').innerText = name;
    }

    function checkCode() {
        const val = document.getElementById('access-code').value.trim().toLowerCase();
        const validCodes = ["í¬ìœ ", "í¬ ìœ ", "foryou", "for you"];
        if (validCodes.includes(val)) loginSuccess("íšŒì›");
        else alert("ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }

    // ìŒì„± ì¸ì‹ ê¸°ëŠ¥
    function startVoiceRecognition() {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ko-KR';
        recognition.start();
        document.getElementById('face-status').innerText = "ìŒì„± ì¸ì‹ ì¤‘...";
        
        recognition.onresult = (event) => {
            const result = event.results[0][0].transcript;
            document.getElementById('access-code').value = result;
            checkCode();
        };
        recognition.onerror = () => alert("ìŒì„± ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }

    function openSub(id) { document.getElementById('main-app').style.display='none'; document.getElementById('sub-'+id).style.display='flex'; }
    function closeSub() { document.querySelectorAll('.sub-screen').forEach(s=>s.style.display='none'); document.getElementById('main-app').style.display='flex'; }
</script>
</body>
</html>